<html>
  <head>
    <meta charset="UTF-8">
    <title>React Tables</title>
    <script src="lib//react-0.11.2.js"></script>
    <script src="lib/JSXTransformer-0.11.2.js"></script>
	<script src="util.js"></script>
    <style>
        body{
	        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
		    color: #212121;
        }
	    table{
	        border-collapse: collapse;
            margin-top: 10px;
	    }
	    td, th{
            border: 1px solid #0288d1;
            padding: 3px 7px 2px 7px;
	    }
        th{
            font-size: 1.1em;
            text-align: left;
            padding-top: 5px;
            padding-bottom: 4px;
            background-color: #03a9f4;
            color: #ffffff;
        }
        th.sort-asc:after{
		    content: " \25b4";
        }
        th.sort-desc:after{
            content: " \25be";
        }
        tr:nth-child(even){
            background-color: #b3e5fc;
        }
        tr:nth-child(odd){
            background-color: #ffffff;
        }
        tr:hover{
            background-color: #81d4fa;
        }
        tr.selected{
            background-color: #4fc3f7;
        }
	</style>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">
	  /** @jsx React.DOM */
      var d = React.DOM;

	  var tableConfig = {
      'header': 'My Table...',
	  'data': [],
      'sortBy': 'name',
      'multipleSelect': true,
      'columns': [
          {'key':'prop1', 'prop': 'name',  'label': 'Name',  'sortable': 'true', 'visible':true},
	      {'key':'prop2', 'prop': 'uid',   'label': 'Konto', 'sortable': 'true', 'visible':true},
	      {'key':'prop3', 'prop': 'pnr',   'label': 'Pnr',   'sortable': 'true', 'visible':false},
	      {'key':'prop4', 'prop': 'email', 'label': 'Email', 'sortable': 'true', 'visible':true}
	  ]};

      var users = UsersGenerator.get(5);
      for(var i = 0; i < users.length; i++){
          var user = users[i];
          var name = user.surname + ", " + user.givenname;
          var pnr = user.pnr;
          var email = user.email;
	      tableConfig.data.push({
		      name: name,
              uid: user.uid,
              pnr:pnr,
              email:email
          });
	  }
	  //------------------------------------------------------------------------
      // Utils
	  //------------------------------------------------------------------------
/*
	  var TDs = function(row, props){
	          var cells=[];
	          props.map(function(p, i){
                  if(p.visible){
                      cells.push(d.td({key:i}, row[p.prop]));
                  }
              });
              return cells;
	  };

	  var THs = function(props){
	          var cells=[];
	          props.map(function(p, i){
                  if(p.visible){
                      cells.push(d.th({key:i}, p.label));
                  }
              });
              return cells;
	  };

	  var OPTs = function(props){
	          var opts=[];
	          props.map(function(p, i){
                  opts.push(d.option({value:i, key:p.prop }, p.label));
              });
              return opts;
	  };
*/

	  //------------------------------------------------------------------------
      // Components
	  //------------------------------------------------------------------------
	  var ColumnFilter = React.createClass({
	      getInitialState: function() {
              return {columns: this.props.columns};
          },
          onSelect : function(event) {
	          var columns = this.state.columns;
	          var options = event.target.options;
              var selOpts = event.target.selectedOptions;
	          var selectedValues = [];

	          for(var i = 0; i < selOpts.length; i++){
			      selectedValues.push(selOpts[i].value);
              }

              this.props.onSelect(selectedValues);
	      },
	      render: function() {
              var columns = this.state.columns;
			  var selectedValues = columns.filter(function(c){return c.visible}).map(function(c){return c.prop});

              return (
                  <select value={selectedValues} multiple={true} onChange={this.onSelect}>
					{columns.map(function(c, i){ return(
					    <option value={c.prop} key={c.prop}>{c.label}</option>
                    )})}
                  </select>
	      )},
	  });

	  var Table = React.createClass({
	      getInitialState: function() {
              var sortBy = this.props.sortBy || this.props.columns[0].prop;
              return {
				  data: this.props.data,
				  columns: this.props.columns,
				  sortBy: sortBy,
				  direction:'asc',
                  selectedRows: []
			 };
          },
	      handleTHClick : function(event){
              var selectedProp = event.target.dataset.prop;
			  var direction = this.state.direction
              if(selectedProp == this.state.sortBy){
                 direction = (direction == 'asc') ? 'desc':'asc';
              } else {
                 direction = 'asc';
              }
              this.setState({sortBy: selectedProp, direction:direction});
		  },
	      handleTRClick : function(event){
              var rows = this.state.data;
              var selectedRows = this.state.selectedRows;

              var isAlreadySelected = function(row){
                  return selectedRows.filter(function(alreadySelectedRow){
			          return alreadySelectedRow == row;
			      }).length > 0;
              };
              
              var node = event.target;
              while(node.tagName != "TR"){
                  node = node.parentNode;
              }

			  var selectedIdx = node.sectionRowIndex;
              var row = rows[selectedIdx];

              var isMultipleSelect = this.props.multipleSelect && event.ctrlKey;

			  if (isMultipleSelect){
				  if (isAlreadySelected(row)) {
                      // unselect if already selected
			          selectedRows = selectedRows.filter(function(alreadySelectedRow){
			              return alreadySelectedRow != row;
			          });
				  } else { 
                      selectedRows.push(row);
                  }
			  } else {
                  selectedRows=[row];
			  }

			  this.setState({'selectedRows': selectedRows});
		  },
	      render: function() {
              var me = this;
              var columns = this.state.columns;
              var sortBy = this.state.sortBy;
              var direction = this.state.direction;
              var selectedRows = this.state.selectedRows;

              var data = this.state.data.sort(function(a,b){
                  var aValue = a[sortBy] || "";
                  var bValue = b[sortBy] || "";
                  if(direction == 'asc'){
                      return aValue.localeCompare(bValue);
                  } else {
                      return bValue.localeCompare(aValue);
                  }
              }).map(function(row){
                  row.isSelected = false;
                  for(var i = 0; i < selectedRows.length; i++){
                      if(row == selectedRows[i]){
                          row.isSelected = true;
                          break;
                      }
                  }
                  return row;
              });

              return (
	              <table>
                      <thead>
                          <tr>
						      {columns.map(function(c, i){if(c.visible){
                                  var className = '';
                                  if(c.prop == sortBy){
                                     className = 'sort-'+direction;
                                  }

                                  return(
				                      <th className={className} key={'header-' + i} data-prop={c.prop} onClick={me.handleTHClick}>{c.label}</th>
						      )}})}
						  </tr>
                      </thead>
                      <tbody>
					      {data.map(function(row, i){
                              var className = row.isSelected ? 'selected' : '';
                              return (
	                          <tr className={className} key={'row-' + i} onClick={me.handleTRClick}>
							      {columns.map(function(c, j){if(c.visible){return(
					                  <td key={'cell-' + i + '-' + j}>{row[c.prop]}</td>
							      )}})}
                              </tr>
                           );})}
                      </tbody>
                  </table>
	         );
	      },
	  });

	  var TableBox = React.createClass({
	      getInitialState: function() {
              return {'data': this.props.data, 'columns': this.props.columns};
          },

	      render: function() {
              var isSelected = function(col, selectedValues){
                  for(var i = 0; i < selectedValues.length; i++){
                      if(col.prop == selectedValues[i]){
                          return true;
                      }
                  }
                  return false;
			  };
              var me = this;
              var data = this.state.data;
              var columns = this.state.columns;
			  var sortBy = this.props.sortBy;
              var multipleSelect = this.props.multipleSelect||false;

		      var onColumnsChange = function(selectedValues){
				  columns.map(function(c){
                      c.visible = isSelected(c, selectedValues);
                  });
				  me.setState({'columns':columns});
			  };
              return (
	             <div>
                     <h1>{this.props.header}</h1>
	                 <ColumnFilter columns={columns} onSelect={onColumnsChange}/>
	                 <Table data={data} columns={columns} sortBy={sortBy} multipleSelect={multipleSelect}/>
				 </div>
	          );
	      }
	  });

  	  //------------------------------------------------------------------------
	  // Bootstrap
	  //------------------------------------------------------------------------

	  React.renderComponent(
	      TableBox(tableConfig), document.getElementById('content')
	  );
    </script>
  </body>
</html>
